<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--favicon-->
    <link rel="icon" href="{{ request.url_for('static', path='assets/images/icon.png') }}" type="image/png" />

    <link href="{{ request.url_for('static', path='assets/plugins/simplebar/css/simplebar.css') }}" rel="stylesheet" />

    <link href="{{ request.url_for('static', path='assets/plugins/metismenu/css/metisMenu.min.css') }}"
        rel="stylesheet" />
    <!-- loader-->
    <link href="{{ request.url_for('static', path='assets/css/pace.min.css') }}" rel="stylesheet" />
    <script src="{{ request.url_for('static', path='assets/js/pace.min.js') }}"></script>
    <!-- Bootstrap CSS -->
    <link href="{{ request.url_for('static', path='assets/css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ request.url_for('static', path='assets/css/bootstrap-extended.css') }}" rel="stylesheet">

    <link href="{{ request.url_for('static', path='assets/css/app.css') }}" rel="stylesheet">
    <link href="{{ request.url_for('static', path='assets/css/icons.css') }}" rel="stylesheet">

    <title>Helm Detection</title>
</head>

<body>
    <!--wrapper-->
    <div class="wrapper">
        <!--sidebar wrapper -->
        <div class="sidebar-wrapper" data-simplebar="true">
            <div class="sidebar-header">
                <div>
                    <img src="{{ request.url_for('static', path='assets/images/icon.png') }}" class="logo-icon"
                        alt="logo icon">
                </div>
                <div>
                    <h4 class="logo-text">VizoHelm</h4>
                </div>
                <div class="toggle-icon ms-auto"><i class='bx bx-arrow-to-left'></i>
                </div>
            </div>
            <!--navigation-->
            <ul class="metismenu" id="menu">
                <li>
                    <a href="/">
                        <div class="parent-icon"><i class='bx bx-home-circle'></i>
                        </div>
                        <div class="menu-title">Dashboard</div>
                    </a>
                </li>

                <li class="menu-label">CCTV Live Stream</li>

                <li>
                    <a href="javascript:;" class="has-arrow">
                        <div class="parent-icon"><i class='bx bx-webcam'></i>
                        </div>
                        <div class="menu-title">Banda Aceh</div>
                    </a>
                    <ul>
                        <li>
                            <a href="{{ request.url_for('camera_view', camera_id='simpang_dharma3') }}"><i
                                    class="bx bx-right-arrow-alt"></i>Simpang Dharma 3</a>
                        </li>
                        <li>
                            <a href="{{ request.url_for('camera_view', camera_id='simpang_dharma4') }}"><i
                                    class="bx bx-right-arrow-alt"></i>Simpang Dharma 4</a>
                        </li>
                    </ul>
                </li>

                <li>
                    <a href="javascript:;" class="has-arrow">
                        <div class="parent-icon">
                            <i class='bx bx-webcam'></i>
                        </div>
                        <div class="menu-title">Medan</div>
                    </a>
                    <ul>
                        <li>
                            <a href="{{ request.url_for('camera_view', camera_id='katamso_aniidrus') }}"><i
                                    class="bx bx-right-arrow-alt"></i>Katamso Ani Idrus</a>
                        </li>
                        <li>
                            <a href="{{ request.url_for('camera_view', camera_id='katamso_masjidraya') }}"><i
                                    class="bx bx-right-arrow-alt"></i>Katamso Masjid
                                Raya</a>
                        </li>
                    </ul>
                </li>

                <li>
                    <a href="javascript:;" class="has-arrow">
                        <div class="parent-icon">
                            <i class='bx bx-webcam'></i>
                        </div>
                        <div class="menu-title">Jakarta</div>
                    </a>
                    <ul>
                        <li>
                            <a href="{{ request.url_for('camera_view', camera_id='gelora1') }}"><i
                                    class="bx bx-right-arrow-alt"></i>Gelora</a>
                        </li>
                        <li>
                            <a href="{{ request.url_for('camera_view', camera_id='gelora2') }}"><i
                                    class="bx bx-right-arrow-alt"></i>Gelora 2</a>
                        </li>
                    </ul>
                </li>

                <li>
                    <a href="javascript:;" class="has-arrow">
                        <div class="parent-icon">
                            <i class='bx bx-webcam'></i>
                        </div>
                        <div class="menu-title">Pematang Siantar</div>
                    </a>
                    <ul>
                        <li>
                            <a href="{{ request.url_for('camera_view', camera_id='simpang_lr20') }}"><i
                                    class="bx bx-right-arrow-alt"></i>Sp Lorong 20</a>
                        </li>
                    </ul>
                </li>

                <li class="menu-label">Upload Files</li>

                <li>
                    <a href="{{ request.url_for('upload_image') }}">
                        <div class="parent-icon">
                            <i class='bx bxs-file-jpg'></i>
                        </div>
                        <div class="menu-title">Input Images</div>
                    </a>
                </li>

                <li style="pointer-events: none; cursor: not-allowed; opacity: 0.5;">
                    <a href="#">
                        <div class="parent-icon">
                            <i class='bx bxs-video'></i>
                        </div>
                        <div class="menu-title">Records</div>
                    </a>
                </li>

                <li class="menu-label">Database</li>

                <li class="mm-active">
                    <a href="{{ request.url_for('data') }}">
                        <div class="parent-icon">
                            <i class='bx bxs-data'></i>
                        </div>
                        <div class="menu-title">View Data</div>
                    </a>
                </li>
            </ul>
            <!--end navigation-->
        </div>

        <!--end sidebar wrapper -->
        <!--start header -->
        <header>
            <div class="topbar d-flex align-items-center">
                <nav class="navbar navbar-expand">
                    <div class="mobile-toggle-menu"><i class='bx bx-menu'></i>
                    </div>
                    <div class="search-bar flex-grow-1">
                        <div class="position-relative search-bar-box">
                            <input type="text" class="form-control search-control" placeholder="Type to search...">
                            <span class="position-absolute top-50 search-show translate-middle-y"><i
                                    class='bx bx-search'></i></span>
                            <span class="position-absolute top-50 search-close translate-middle-y"><i
                                    class='bx bx-x'></i></span>
                        </div>
                    </div>
                    <div class="top-menu ms-auto">
                        <ul class="navbar-nav align-items-center">
                            <li class="nav-item mobile-search-icon">
                                <a class="nav-link" href="#"> <i class='bx bx-search'></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="user-box dropdown">
                        <a class="d-flex align-items-center nav-link dropdown-toggle dropdown-toggle-nocaret" href="#"
                            role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <img src="{{ request.url_for('static', path='assets/images/avatars/avatar-2.png') }}"
                                class="user-img" alt="user avatar">
                            <div class="user-info ps-3">
                                <p class="user-name mb-0">Admin</p>
                                <p class="designattion mb-0">Administrator</p>
                            </div>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="javascript:;"><i
                                        class='bx bx-log-out-circle'></i><span>Logout</span></a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
        </header>
        <!--end header -->

        <!--start page wrapper -->
        <div class="page-wrapper">
            <div class="page-content">

                <div class="row">
                    <div class="col-24">
                        <div class="card radius-10">
                            <div class="card-body">
                                <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                                    <!-- Kiri: Judul -->
                                    <div>
                                        <h6 class="mb-0">Table Overview</h6>
                                        <small class="text-muted" id="current-location">(Banda Aceh)</small>
                                    </div>

                                    <!-- Kanan: Dropdown kamera & kota -->
                                    <div class="d-flex align-items-center gap-2">
                                        <!-- Dropdown kamera -->
                                        <select id="camera-filter" class="form-select" style="width: auto;">
                                            <option value="">-- Semua --</option>
                                        </select>

                                        <!-- Dropdown kota -->
                                        <select id="location-filter" class="form-select" style="width: auto;">
                                            <option value="banda_aceh" selected>Banda Aceh</option>
                                            <option value="medan">Medan</option>
                                            <option value="jakarta">Jakarta</option>
                                            <option value="pematang_siantar">Pematang Siantar</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="table-responsive">
                                    <table class="table align-middle mb-0">
                                        <thead class="table-light text-center">
                                            <tr>
                                                <th>No.</th>
                                                <th>Frame</th>
                                                <th>Gambar Tanpa CLAHE</th>
                                                <th>Gambar Dengan CLAHE</th>
                                                <th>Class</th>
                                                <th>Confidence</th>
                                                <th>Status Deteksi</th>
                                                <th>Date</th>
                                                <th>Daerah</th>
                                            </tr>
                                        </thead>
                                        <tbody id="detection-table-body">

                                        </tbody>

                                    </table>

                                    <div class="mt-3 d-flex justify-content-between align-items-center">
                                        <small id="total-data-text" class="text-muted ms-2"></small>
                                        <nav>
                                            <ul class="pagination mb-0" id="pagination-controls">
                                                <!-- halaman akan muncul di sini -->
                                            </ul>
                                        </nav>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <!--end row-->

            </div>
        </div>
        <!--end page wrapper -->

        <!--start overlay-->
        <div class="overlay toggle-icon"></div>
        <!--end overlay-->

        <!--Start Back To Top Button-->
        <a href="javaScript:;" class="back-to-top"><i class='bx bxs-up-arrow-alt'></i></a>
        <!--End Back To Top Button-->

        <footer class="page-footer">
            <p class="mb-0">Copyright © 2025. All right reserved.</p>
        </footer>
    </div>
    <!--end wrapper-->

    <!-- Scripts -->
    <script src="{{ request.url_for('static', path='assets/js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ request.url_for('static', path='assets/js/jquery.min.js') }}"></script>
    <script src="{{ request.url_for('static', path='assets/plugins/simplebar/js/simplebar.min.js') }}"></script>
    <script src="{{ request.url_for('static', path='assets/plugins/metismenu/js/metisMenu.min.js') }}"></script>
    <script src="{{ request.url_for('static', path='assets/plugins/chartjs/js/Chart.min.js') }}"></script>
    <script src="{{ request.url_for('static', path='assets/plugins/chartjs/js/Chart.extension.js') }}"></script>

    <!-- Sidebar Toggle -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            document.querySelector('.mobile-toggle-menu').addEventListener('click', function() {
                document.querySelector('.wrapper').classList.toggle('toggled');
            });
            $(".toggle-icon").click(function() {
                const wrapper = $(".wrapper");
                if (wrapper.hasClass("toggled")) {
                    wrapper.removeClass("toggled");
                    $(".sidebar-wrapper").unbind("hover");
                } else {
                    wrapper.addClass("toggled");
                    $(".sidebar-wrapper").hover(
                        () => wrapper.addClass("sidebar-hovered"),
                        () => wrapper.removeClass("sidebar-hovered")
                    );
                }
            });
            $('#menu').metisMenu();
        });
    </script>

    <!-- Location Sync -->
    <script>
        function updateLocationText(location) {
            const labelMap = {
                banda_aceh: "Banda Aceh",
                medan: "Medan",
                jakarta: "Jakarta",
                pematang_siantar: "Pematang Siantar"
            };
            const display = `(${labelMap[location] || location})`;
            document.getElementById("current-location").innerText = display;
        }
        document.addEventListener("DOMContentLoaded", function() {
            document.querySelectorAll(".dropdown-item[data-location]").forEach(item => {
                item.addEventListener("click", () => {
                    const loc = item.getAttribute("data-location");
                    updateLocationText(loc);
                });
            });
        });
    </script>

    <script>
        let currentLocation = "banda_aceh";
        let detectionsData = [];
        let currentPage = 1;
        const rowsPerPage = 10;
        // Mapping kota ke kamera
        const locationToCameras = {
            banda_aceh: {
                simpang_dharma3: "Simpang Dharma 3",
                simpang_dharma4: "Simpang Dharma 4"
            },
            medan: {
                katamso_aniidrus: "Katamso Ani Idrus",
                katamso_masjidraya: "Katamso Masjid Raya"
            },
            jakarta: {
                gelora1: "Gelora 1",
                gelora2: "Gelora 2"
            },
            pematang_siantar: {
                simpang_lr20: "Sp. Lorong 20"
            }
        };

        function renderTablePage(data, page) {
            const tbody = document.getElementById("detection-table-body");
            tbody.innerHTML = "";
            document.getElementById("total-data-text").innerText =
                `Menampilkan ${Math.min(page * rowsPerPage, data.length)} dari ${data.length} data`;
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedItems = data.slice(start, end);
            paginatedItems.forEach((item, idx) => {
                const row = document.createElement("tr");
                row.classList.add("text-center");
                row.innerHTML = `
                <td>${start + idx + 1}</td>
                <td>${item.frame}</td>
                <td>
                    <div style="display: flex; justify-content: center; align-items: center; height: 100px;">
                        <img src="/static/${item.Gambar_Tanpa_CLAHE === '-' ? '/assets/images/no_image.jpg' : item.Gambar_Tanpa_CLAHE}" class="product-img-2" style="max-width: 100px;">
                    </div>
                </td>

                <td>
                    <div style="display: flex; justify-content: center; align-items: center; height: 100px;">
                    <img src="/static/${item.Gambar_Dengan_CLAHE === '-' ? '/assets/images/no_image.jpg' : item.Gambar_Dengan_CLAHE}" class="product-img-2" style="max-width: 100px;">
                    </div>    
                </td>
                
                <td>
                    <span class="badge ${item.class.toLowerCase() === 'helm' ? 'bg-gradient-quepal' : 'bg-gradient-bloody'} text-white shadow-sm w-100">
                        ${item.class}
                    </span>
                </td>
                <td>${item.confidence}</td>
                <td>${item.Status_Deteksi}</td>
                <td>${item.date}</td>
                <td>${item.location}</td>
            `;
                tbody.appendChild(row);
            });
            renderPaginationControls(data.length, page);
        }

        function renderPaginationControls(totalItems, currentPage) {
            const totalPages = Math.ceil(totalItems / rowsPerPage);
            const pagination = document.getElementById("pagination-controls");
            pagination.innerHTML = "";
            const createPageItem = (page, label = null, active = false, disabled = false) => {
                const li = document.createElement("li");
                li.className = "page-item" + (active ? " active" : "") + (disabled ? " disabled" : "");
                li.innerHTML = `<a class="page-link" href="#">${label || page}</a>`;
                if (!disabled) {
                    li.addEventListener("click", (e) => {
                        e.preventDefault();
                        renderTablePage(detectionsData, page);
                    });
                }
                return li;
            };
            pagination.appendChild(
                createPageItem(currentPage - 1, "« Prev", false, currentPage === 1)
            );
            pagination.appendChild(createPageItem(1, "1", currentPage === 1));
            if (currentPage > 4) {
                pagination.appendChild(createPageItem(null, "...", false, true));
            }
            const start = Math.max(2, currentPage - 1);
            const end = Math.min(totalPages - 1, currentPage + 1);
            for (let i = start; i <= end; i++) {
                pagination.appendChild(createPageItem(i, null, currentPage === i));
            }
            if (currentPage < totalPages - 3) {
                pagination.appendChild(createPageItem(null, "...", false, true));
            }
            if (totalPages > 1) {
                pagination.appendChild(createPageItem(totalPages, null, currentPage === totalPages));
            }
            pagination.appendChild(
                createPageItem(currentPage + 1, "Next »", false, currentPage === totalPages)
            );
        }

        function loadDetections(location = currentLocation, cameraFilter = "") {
            fetch(`/detections_by_location/${location}`)
                .then(res => res.json())
                .then(data => {
                    if (cameraFilter) {
                        detectionsData = data.filter(item =>
                            (item.Gambar_Tanpa_CLAHE && item.Gambar_Tanpa_CLAHE.includes(cameraFilter)) ||
                            (item.Gambar_Dengan_CLAHE && item.Gambar_Dengan_CLAHE.includes(cameraFilter))
                        );
                    } else {
                        detectionsData = data;
                    }
                    renderTablePage(detectionsData, 1);
                });
        }

        function updateLocationText(location) {
            const labelMap = {
                banda_aceh: "Banda Aceh",
                medan: "Medan",
                jakarta: "Jakarta",
                pematang_siantar: "Pematang Siantar"
            };
            const display = `(${labelMap[location] || location})`;
            document.getElementById("current-location").innerText = display;
        }

        function updateCameraFilterOptions(location) {
            const select = document.getElementById("camera-filter");
            select.innerHTML = `<option value="">-- Semua --</option>`;
            if (locationToCameras[location]) {
                for (const [value, label] of Object.entries(locationToCameras[location])) {
                    const option = document.createElement("option");
                    option.value = value;
                    option.textContent = label;
                    select.appendChild(option);
                }
            }
        }
        document.addEventListener("DOMContentLoaded", function() {
            // Set default kota di UI dan JS
            document.getElementById("location-filter").value = "banda_aceh";
            currentLocation = "banda_aceh";
            updateCameraFilterOptions(currentLocation);
            loadDetections(currentLocation);
            updateLocationText(currentLocation);
            // Load default view
            updateCameraFilterOptions(currentLocation);
            loadDetections();
            // Kota dropdown
            document.getElementById("location-filter").addEventListener("change", function() {
                const loc = this.value;
                currentLocation = loc;
                updateCameraFilterOptions(loc);
                document.getElementById("camera-filter").value = "";
                loadDetections(loc);
                updateLocationText(loc);
            });
            // Filter kamera spesifik
            document.getElementById("camera-filter").addEventListener("change", function() {
                const cam = this.value;
                loadDetections(currentLocation, cam);
            });
        });
    </script>

</body>

</html>